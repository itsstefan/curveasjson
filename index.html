
<!--

https://observablehq.com/@d3/spline-editor
https://codepen.io/realjameal/pen/gpzZGw
https://www.ybbshaeuschen.at/2018/02/10/dimensionierung-der-photovoltaik-anlage/


-->

<html>
  <head>
    <title>Curve As JSON</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/protovis/3.3.1/protovis.min.js"></script>
    <style type="text/css">
        #center {
            width: 1440px;
            margin: auto;
        }

        #output {
            width: 100%;
        }
    </style>
  
    <script language="javascript">

        function copyToClipboard() 
        {
            var copyText = document.getElementById("output");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyText.value);
        }

        function createOutputFrom(points)
        {   
            var rv = "";
            path = document.getElementById("fig").firstChild.nextSibling.firstChild.firstChild.nextSibling.firstChild; // hackadyway

            // project to y (amd normalize values from 1...400 to 1000...1 => 1000-2.5*value)
            var p = [];
            for (var i = 0; i < 1440; i++) {
                p[i] = 0;
            }

            length = path.getTotalLength();
            for (var i = 0; i < length; i++) {
                point = path.getPointAtLength(i);
                x = parseInt(point.x);
                y = parseInt(point.y);
                scaled_y = 1000 - 2.5*y;
                //console.log(i + "/" + x + "/" + y + "//" + scaled_y);
                p[x] = scaled_y; // will sometimes overwrite but that's ok
            }

            for (var i = 0; i < 1440; i += 100) {
                rv += i + ":" + p[i] + ",\n";
            }
            return rv;
        }
    </script>
  </head>
  <body>
      
  <div id="center">
    <div id="fig">
    <script type="text/javascript+protovis">

        var w = 1440, h = 400, i = 3, interpolate = "cardinal", segmented = false;

        var points = pv.range(1, 5).map(function(i) ({
        x: i * w / 5,
        y: 50 + Math.random() * (h - 100)
        }));

        var vis = new pv.Panel()
            .width(w)
            .height(h)
            .fillStyle("#fff")
            .strokeStyle("#ccc")
            .lineWidth(4)
            .antialias(false)
            .margin(0)
            .event("mousedown", function() (i = points.push(this.mouse()) - 1, this));

        vis.add(pv.Line)
            .data(function() points)
            .left(function(d) d.x)
            .top(function(d) d.y)
            .interpolate(function() interpolate)
            .segmented(function() segmented)
            .strokeStyle("#ff0000")
            .tension(0.5)
            .lineWidth(2);

        vis.add(pv.Dot)
            .data(function() points)
            .left(function(d) d.x)
            .top(function(d) d.y)
            .radius(6)
            .cursor("move")
            .strokeStyle(function() i == this.index ? "#ff0000" : "#000000")
            .fillStyle(function() this.strokeStyle().alpha(1.0))
            .event("mousedown", pv.Behavior.drag())
            .event("dragstart", function() (i = this.index, this))
            .event("drag", vis);

        vis.render();

        pv.listen(window, "mousedown", function() self.focus());
        pv.listen(window, "keydown", function(e) {
        // delete selected point via keyboard; code 8 is backspace, code 46 is delete
        if ((e.keyCode == 8 || e.keyCode == 46) && (i >= 0)) {
            points.splice(i--, 1);
            vis.render();
            e.preventDefault();
        }
        });

    </script>
    </div> <!-- fig -->

  <button onclick="document.getElementById('output').innerHTML = createOutputFrom(points)">Create JSON</button><br>
  
  <!-- <ul>
      <li>add interlacing</li>
      <li>add output scaling</li>
      <li>done ;-)</li>
  </ul> -->

  <textarea style="resize: none; width: 1440px" id="output" rows="10"></textarea><br>
  <button onclick="copyToClipboard()">Copy to clipboard</button>
  

</div> <!-- center -->


</body>
</html>
